#!/usr/bin/env bash

# Copyright (C) Indrajit Roy <eendroroy@gmail.com>
#
# SPDX-License-Identifier: AGPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.

# shellcheck disable=SC2034

_____SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

source "$_____SCRIPT_DIR"/../src/__variables.sh
source "$_____SCRIPT_DIR"/../src/__message.sh
# shellcheck source=/dev/null
for script in "$_____SCRIPT_DIR"/../src/func/*.sh; do source "$script"; done

[[ $# -eq 0 ]] && { __help; exit 1; }

# Argument defaults
command=""
branch=false
args=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    # Parse Options
    --exclude |-e) GITTER_FILTER_EXCLUDE=true; shift ;;
    --filter  |-f) shift; __read_filter "$1";  shift ;;
    --no-color   ) __set_no_color;             shift ;;
    --verbose |-v) GITTER_VERBOSE=true;        shift ;;

    # Parse Commands
    git       |g ) ___git;  shift ;;
    exec      |x ) ___exec; shift ;;
    list      |ls) ___list; shift ;;
               lb) ___lb;   shift ;;
               ll) ___ll;   shift ;;
    help         ) ___help; shift ;;

    # Parse Command Arguments
    --) __read_command_args "$@"; break ;;

    # Handle Unknown Options/Arguments
    --*|-*) __handle_unknown_option "$1" ;;
    *     ) __handle_unknown_arg    "$1" ;;
  esac
done

[[ "$command" == "help" ]] && { __help; exit 0; }
[[ -z "$command" ]] && command="git"
[[ "$command" != "list" && ${#args[@]} -eq 0 ]] && __invalid_args_for_command_list

# -- find all git repositories in the current directory
readarray -d '' -t repositories < <(find . -name ".git" -maxdepth "$((GITTER_MAX_DEPTH+1))" -type d -print0)
[[ ${#repositories[@]} -eq 0 ]] && __no_repository_found

# -- process .gitterignore if exists
[[ -f .gitterignore ]] && __process_gitterignore repositories
[[ ${#repositories[@]} -eq 0 ]] && __all_repositories_ignored

# -- apply user specified filters
__filter_repos repositories
[[ ${#repositories[@]} -eq 0 ]] && __all_repositories_filtered_out

# -- execute 'list' command
if [[ "$command" == "list" ]]; then
  for repository in "${repositories[@]}"; do
    repo_dir=$(dirname "$repository")
    echo -ne "${GITTER_C_SUCCESS}${GITTER_PRIMARY_SYMBOL}${GITTER_C___RESET} "
    __repo_status "$repo_dir" "$branch"
    echo
    continue
  done
  exit 0
fi

# -- set command and args for 'exec' command
[[ "$command" == "exec" ]] && command="${args[0]}" && args=("${args[@]:1}")

# -- execute git/exec commands in each repository
for repository in "${repositories[@]}"; do
  repo_dir=$(dirname "$repository")
  (
    __enter_repo_dir "$repo_dir"
    __expand_args args

    echo -e "${GITTER_C_SUCCESS}${GITTER_PRIMARY_SYMBOL} \$(${command} ${args[*]})${GITTER_C___RESET} ${GITTER_C_____DIM}in${GITTER_C___RESET} $(__repo_status ".")"
    command -- "$command" "${args[@]}" 1> >(__handle_stdout) 2> >(__handle_stderr)
  )
done
exit 0