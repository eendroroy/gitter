#!/usr/bin/env bash

# Copyright (C) Indrajit Roy <eendroroy@gmail.com>
#
# SPDX-License-Identifier: AGPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.

# shellcheck disable=SC2034
____GITTER____LINK="https://github.com/eendroroy/gitter"
____GITTER_VERSION="0.0.1"
_____SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

source "$_____SCRIPT_DIR"/../src/__variables.sh
# shellcheck source=/dev/null
for script in "$_____SCRIPT_DIR"/../src/func/*.sh; do source "$script"; done

[[ $# -eq 0 ]] && { __help; exit 1; }

# Argument defaults
command=""
args=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    # Parse Commands
    git     |g ) ___git              ;;
    exec    |x ) ___exec             ;;
    eval    |e ) ___eval             ;;
    list    |ls) ___list             ;;
             lb) ___lb               ;;
             ll) ___ll               ;;
    config  |c ) ___config           ;;
    help       ) ___help "$@"; break ;;
    version |v ) ___version          ;;

    # Parse Options
    --max-depth         |-d) shift; __read_max_depth "$1"          ;;
    --exclude           |-e)        GITTER_FILTER_EXCLUDE=true     ;;
    --filter            |-f) shift; __read_filter "$1"             ;;
    --ask-confirm       |-a)        GITTER_ASK_CONFIRMATION=true   ;;
    --continue-on-error |-c)        GITTER_CONTINUE_ON_ERROR=true  ;;
    --no-color             )        GITTER_NO_COLOR=true           ;;
    --verbose           |-v)        GITTER_VERBOSE=true            ;;

    # Parse Command Arguments
    --) __read_command_args "$@"; break ;;

    # Handle Unknown Options/Arguments
    --*|-*) __unknown_option "$1" ;;
    *     ) __unknown_arg    "$1" ;;
  esac
  shift
done

[[ "$GITTER_NO_COLOR" == true ]] && __disable_color_output

[[ -z "$command" ]] && command="git"

[[ "$command" == "help"              ]] && { __help;              exit 0; }
[[ "$command" == "help-filter"       ]] && { __help_filter;       exit 0; }
[[ "$command" == "help-gitterignore" ]] && { __help_gitterignore; exit 0; }
[[ "$command" == "help-placeholder"  ]] && { __help_placeholder;  exit 0; }
[[ "$command" == "help-status"       ]] && { __help_status;       exit 0; }
[[ "$command" == "config"            ]] && { __print_config;      exit 0; }
[[ "$command" == "version"           ]] && { __version;      exit 0; }

[[ "$command" != "list" && ${#args[@]} -eq 0 ]] && __invalid_args_for_command "$command"

# -- find all git repositories in the current directory
readarray -d '' -t repositories < <(find . -name ".git" -maxdepth "$((GITTER_MAX_DEPTH+1))" -type d -print0)
[[ ${#repositories[@]} -eq 0 ]] && __no_repository_found

# -- process .gitterignore if exists
[[ -f .gitterignore ]] && __process_gitterignore repositories
[[ ${#repositories[@]} -eq 0 ]] && __all_repositories_ignored

# -- apply user specified filters
__filter_repos repositories
[[ ${#repositories[@]} -eq 0 ]] && __all_repositories_filtered_out

# -- execute 'list' command
if [[ "$command" == "list" ]]; then
  for repository in "${repositories[@]}"; do
    repo_dir=$(dirname "$repository")
    echo -ne "${GITTER_C_SUCCESS}${GITTER_PRIMARY_SYMBOL}${GITTER_C___RESET} "
    __repo_status "$repo_dir"
    echo
    continue
  done
  exit 0
fi

# -- set command and args for 'exec' command
[[ "$command" == "exec" ]] && command="${args[0]}" && args=("${args[@]:1}")

# -- execute git/exec commands in each repository
repo_index=0
total_repos=${#repositories[@]}
for repository in "${repositories[@]}"; do
  repo_index=$((repo_index+1))

  [[ "$GITTER_CONTINUE_ON_ERROR" == false && "$exit_code" -ne 0 ]] && __ask_on_error "$exit_code" "$repo_index" "$total_repos"

  repo_dir=$(dirname "$repository")
  (
    __enter_repo_dir "$repo_dir"
    __expand_args args

    args_string="${args[*]}"
    [[ ${#args_string} -gt 80 ]] && args_string="${args_string:0:77}..."

    echo -e "${GITTER_C_SUCCESS}${GITTER_PRIMARY_SYMBOL}${GITTER_C___RESET} $(__repo_status ".")"
    echo -ne "   ${GITTER_C_____DIM}\$(${GITTER_C___RESET}${GITTER_C_COMMAND}${command}"
    echo -e  " ${GITTER_C_____ARG}${args_string}${GITTER_C___RESET}${GITTER_C_____DIM})${GITTER_C___RESET}"
    [[ "$command" == "git" ]] && args=("-c" "color.ui=always" "${args[@]}")

    [[ "$GITTER_ASK_CONFIRMATION" == true && "$exit_code" -eq 0 ]] && __ask_to_proceed "$repo_index" "$total_repos"

    command -- "$command" "${args[@]}" 1> >(__handle_stdout) 2> >(__handle_stderr)
  )
  exit_code=$?
done

exit 0