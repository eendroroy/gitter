#!/usr/bin/env bash

# Copyright (C) Indrajit Roy <eendroroy@gmail.com>
#
# SPDX-License-Identifier: AGPL-3.0-or-later
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.

_____SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)

for script in "$_____SCRIPT_DIR"/../src/func/*.sh; do
  # shellcheck source=/dev/null
  source "$script"
done

source "$_____SCRIPT_DIR"/../src/__vars.sh
source "$_____SCRIPT_DIR"/../src/__command_fn.sh

if [[ $# -eq 0 ]]; then
  __help
  exit 1
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    # Parse Options
    --exclude |-e ) exclude=true;              shift ;;
    --filter  |-f ) shift; __read_filter "$1"; shift ;;
    --no-color    ) __set_no_color;            shift ;;
    --verbose |-v ) verbose=true;              shift ;;

    # Parse Commands
    git       |g  ) ___git;  shift ;;
    exec      |x  ) ___exec; shift ;;
    list      |ls ) ___list; shift ;;
               lb ) ___lb;   shift ;;
               ll ) ___ll;   shift ;;
    help          ) ___help; shift ;;

    # Parse Command Arguments
    --            ) __read_command_args "$@"; break ;;

    # Handle Unknown Options/Arguments
    --*           ) __handle_unknown_option "$1" ;;
    -*            ) __handle_unknown_option "$1" ;;
    *             ) __handle_unknown_arg    "$1" ;;
  esac
done

if [[ "$command" == "help" ]]; then
  __help
  exit 0
fi

# Set default command type if none specified
[[ -z "$command" ]] && command="git"

[[ "$command" != "list" && ${#args[@]} -eq 0 ]] && {
  echo
  echo -e "${_C___ERROR}No arguments provided for command:${_C___RESET} $command" 1>&2
  echo
  echo -e "Run ${_C_COMMAND}gitter --help${_C___RESET} for usage information." 1>&2
  echo
  exit 1
}

# -- find all git repositories in the current directory
readarray -d '' -t repositories < <(find . -name ".git" -type d -print0)

if [[ ${#repositories[@]} -eq 0 ]]; then
  echo -e "${_C___ERROR}${___ERROR_SYMBOL}  No git repositories found in the current directory${_C___RESET}" 1>&2
  exit 1
fi

# -- process .gitterignore if exists
if [[ -f .gitterignore ]]; then
  __process_gitterignore repositories
fi

if [[ ${#repositories[@]} -eq 0 ]]; then
  echo -e "${_C___ERROR}${___ERROR_SYMBOL}  All git repositories are ignored by .gitterignore${_C___RESET}" 1>&2
  exit 1
fi

# -- apply user specified filters
__filter_repos repositories

if [[ ${#repositories[@]} -eq 0 ]]; then
  echo -e "${_C___ERROR}${___ERROR_SYMBOL}${_C___RESET}  No git repositories found in the current directory with applied filters" 1>&2
  exit 1
fi

# -- execute 'list' command
if [[ "$command" == "list" ]]; then
  for repository in "${repositories[@]}"; do
    repo_dir=$(dirname "$repository")
    echo -ne "${_C_SUCCESS}${_PRIMARY_SYMBOL}${_C___RESET} "
    __repo_status "$repo_dir" "$branch"
    echo
    continue
  done
  exit 0
fi

# -- set command and args for 'exec' command
[[ "$command" == "exec" ]] && command="${args[0]}" && args=("${args[@]:1}")

# -- execute git/exec commands in each repository
for repository in "${repositories[@]}"; do
  repo_dir=$(dirname "$repository")
  (
    __enter_repo_dir "$repo_dir"

    parsed_args=()
    __expand_args args parsed_args

    echo -e "${_C_SUCCESS}${_PRIMARY_SYMBOL} \$(${command} ${parsed_args[*]})${_C___RESET} ${_C_____DIM}in${_C___RESET} $(__repo_status ".")"
    command -- "$command" "${parsed_args[@]}" 1> >(__handle_stdout) 2> >(__handle_stderr)
  )
done
exit 0